#!/usr/bin/env ruby
# encoding: UTF-8

def down
  # kill chef-zero processes
  # FIXME: OH DEAR GOD THIS IS GROSS MAKE IT RUBY!?
  cz = "chef-zero"
  cmd = <<-EOF
    procs=$(ps aux | egrep "#{cz}" | grep -v grep | awk '{print $2}')
    if [ "$procs" ]; then
        printf "\e[31mKilling all /#{cz}/\e[00m\n"
        for proc in $procs; do
            printf "  \e[31mKilling $proc\e[00m\n"
            kill -9 $proc
        done
    else
        printf "\e[33mNo processes found matching /#{cz}/\e[00m\n"
    fi
    EOF
  ::Kernel.system(cmd)

  # cleans up berks stuff, remove knife.rb and berkshelf config
  # FIXME: what if knife_file or berks_json is not default?
  %w{ cookbooks default tmp }.
    map  { |dir| "#{ENV["HOME"]}/.berkshelf/#{dir}/*" }.
    each { |dir| ::Kernel.system("rm -rf #{dir}") }
  %w{ Berksfile.*lock .chef/knife.rb .berkshelf/config.json }.
    each { |f| ::Kernel.system("rm -f #{f}") }
end

down
