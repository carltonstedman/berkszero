#!/usr/bin/env ruby
# encoding: UTF-8

require "fileutils"
require "open3"

def down
  # kill chef-zero processes
  ::Open3.popen3("ps aux") do |_stdin, stdout, _stderr, _wait_thr|
    pids = stdout.readlines.
      reject { |ln| %r{chef-zero}.match(ln).nil? }.
      map    { |ln| ln.split(" ")[1].to_i }
    if pids.empty?
      puts "\e[33mNo processes found matching /chef-zero/\e[00m"
    else
      puts "\e[31mKilling all /chef-zero/\e[00m"
      pids.each do |pid|
        puts "  \e[31mKilling #{pid}\e[00m"
        ::Process.kill("HUP", pid)
      end
    end
  end

  # cleans up berks stuff, remove knife.rb and berkshelf config
  # FIXME: what if knife_file or berks_json is not default?
  %w{ cookbooks default tmp }.
    map { |dir| ::File.join(ENV["HOME"], ".berkshelf/#{dir}") }.
    push(%w{ Berksfile.lock .chef/knife.rb .berkshelf/config.json }).
    flatten.
    each { |f| ::FileUtils.rm_rf f }
end

down
